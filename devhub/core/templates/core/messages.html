{% extends 'core/base.html' %}
{% block title %}Messages | VTS Designers{% endblock %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/messages.css' %}">

<div class="messages-wrapper">
    <!-- Sidebar -->
    <div class="message-sidebar">
        <div class="sidebar-header">
            <h2><i class="bx bx-envelope"></i> Messages</h2>
            <div class="tabs">
                <span class="tab active">All</span>
                <span class="tab">New</span>
            </div>
        </div>
        <div class="message-list">
            {% for convo in conversations %}
            <a href="?user={{ convo.other_user.id }}"
                class="message-item {% if selected_user and convo.other_user.id == selected_user.id %}active{% endif %}">
                {% if convo.other_user.profile_pic %}
                <img src="{{ convo.other_user.profile_pic.url }}">
                {% else %}
                <img src="{% static 'images/default-avatar.png' %}">
                {% endif %}
                <div class="message-info">
                    <strong>{{ convo.other_user.username }}</strong>
                    <p class="user-role">{{ convo.other_user.role|default:"UI/UX Designer" }}</p>
                </div>
            </a>
            {% empty %}
            <p class="empty-msg">No messages yet.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Content -->
    <div class="message-content">
        {% if selected_user %}
        <div class="chat-header">
            <img class="chat-header-avatar"
                src="{% if selected_user.profile_pic %}{{ selected_user.profile_pic.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
                alt="{{ selected_user.username }}">
            <h3>Chat with {{ selected_user.username }}</h3>
        </div>

        <div class="chat-body">
            {% for msg in chat_messages %}
            <div class="chat-msg {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
                <p>{{ msg.content }}</p>
                <span class="chat-time">{{ msg.timestamp|date:"H:i" }}</span>
            </div>
            {% empty %}
            <p>No messages yet.</p>
            {% endfor %}
        </div>
        <!-- Chat input -->
        <form method="POST" class="chat-input">
            {% csrf_token %}
            <input type="text" name="message" placeholder="Type a message..." required>
            <button type="submit">Send</button>
        </form>
        {% else %}
        <div class="chat-header">
            <h3>Select a conversation</h3>
        </div>
        <div class="chat-body">
            <p>Select a conversation to view messages.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const chatBody = document.querySelector(".chat-body");
        if (chatBody) {
            chatBody.scrollTop = chatBody.scrollHeight; // Scroll to bottom
        }
        window.scrollTo(0, document.body.scrollHeight);

    });
</script>
{% endblock %}